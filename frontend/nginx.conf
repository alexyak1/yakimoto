server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # Buffer settings
    client_max_body_size 10M;
    client_body_buffer_size 128k;
    
    # Disable sendfile to prevent content length mismatch issues
    # This is especially important when behind a proxy/load balancer
    sendfile off;
    tcp_nopush off;
    tcp_nodelay on;

    # DNS resolver for prerender.io
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    # Redirect www to non-www (only for actual www subdomain)
    if ($host = www.yakimoto.se) {
        return 301 https://yakimoto.se$request_uri;
    }

    # Prerender.io bot detection for SEO
    # Detects search engine crawlers and serves pre-rendered HTML
    set $prerender 0;
    
    # Check for crawler user agents
    if ($http_user_agent ~* "googlebot|bingbot|yandex|baiduspider|duckduckbot|slurp|msnbot|adidxbot|facebookexternalhit|facebot|twitterbot|linkedinbot|embedly|quora link preview|showyoubot|outbrain|pinterest|developers.google.com/+/web/snippet|slackbot|vkShare|W3C_Validator|whatsapp|redditbot|applebot|flipboard|tumblr|bitlybot") {
        set $prerender 1;
    }
    
    # Check for prerender token in query string (for testing)
    if ($args ~ "_escaped_fragment_") {
        set $prerender 1;
    }
    
    # Don't prerender static files
    if ($uri ~* "\.(js|css|xml|less|png|jpg|jpeg|gif|pdf|doc|txt|ico|rss|zip|mp3|rar|exe|wmv|doc|avi|ppt|mpg|mpeg|tif|wav|mov|psd|ai|xls|mp4|m4a|swf|dat|dmg|iso|flv|m4v|torrent|ttf|woff|woff2|svg|eot)$") {
        set $prerender 0;
    }

    # JavaScript and CSS files - enable compression but ensure proper headers
    location ~* \.(js|css)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # Enable gzip for text-based assets
        gzip on;
        gzip_vary on;
        gzip_types text/javascript application/javascript text/css;
        
        # Don't set Content-Length when using gzip - let nginx handle it
        add_header X-Content-Type-Options "nosniff" always;
    }

    # Image files - no compression, long cache
    location ~* \.(png|jpg|jpeg|gif|ico|svg|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # Disable compression for binary files
        gzip off;
        
        # Ensure proper content type
        add_header X-Content-Type-Options "nosniff" always;
    }

    # Font files - no compression
    location ~* \.(woff|woff2|ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        gzip off;
        add_header Access-Control-Allow-Origin "*" always;
    }

    # HTML files - no caching, no compression to avoid issues
    location ~* \.html$ {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header X-Content-Type-Options "nosniff" always;
        gzip off;
    }

    # Main location block for SPA routing
    location / {
        # Route to prerender for search engine bots
        if ($prerender = 1) {
            rewrite .* /_prerender_proxy$uri last;
        }
        
        try_files $uri $uri/ /index.html;
        
        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        
        # Disable compression for root to avoid content length issues
        gzip off;
    }
    
    # Internal location for prerender proxy
    # Get a free token at https://prerender.io (250 pages/month free)
    # Replace YOUR_TOKEN below with your actual token
    location /_prerender_proxy {
        internal;
        
        proxy_hide_header Cache-Control;
        add_header Cache-Control "private, max-age=600";
        
        # Set prerender.io authentication header
        proxy_set_header X-Prerender-Token YOUR_TOKEN;
        proxy_set_header X-Prerender-Int-Type "nginx";
        
        # Strip the /_prerender_proxy prefix and proxy to prerender.io
        # The captured $1 contains the original path (e.g., /products/1)
        rewrite ^/_prerender_proxy(.*)$ /https://yakimoto.se$1 break;
        proxy_pass https://service.prerender.io;
        
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
    }

    error_page 404 /index.html;
}
